{% comment %} <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Visualization</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-image: url('/images/financials.jpg'); /* Change this to your local image path */
            background-size: cover;
            color: white;
        }
        h1 {
            margin-bottom: 20px;
        }
        input[type="file"], 
        button {
            margin: 10px;
            padding: 10px 15px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
        }
        button:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }

        #chartContainer {
            width: 60%;
            max-width: 600px;
            margin-top: 20px;
        } 
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 15px;
            margin: 30px 0;
            padding: 20px;
        }
        
        .chart-wrapper {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .chart-wrapper.full-width {
            grid-column: 1 / -1;
        }
        
        canvas {
            width: 100% !important;
            height: 400px !important;
        }
        
    </style>
</head>

<body>
    
    <h1 style="color: blue;">Analytics</h1>
    <div>
        <input type="file" id="fileInput" accept=".csv">
        <button id="uploadBtn">Upload CSV</button>
    </div>
    <div id="chartContainer">
        <canvas id="salesChart"></canvas>
    </div>
    <div id="analyticsSummary"></div>

    <div class="charts-container">
     <div class="chart-wrapper">
        <canvas id="quantityChart"></canvas>
    </div>
    <div class="chart-wrapper">
        <canvas id="revenueChart"></canvas>
    </div>
    <div class="chart-wrapper full-width">
        <canvas id="combinedChart"></canvas>
    </div>
</div>
    <script src="script.js"></script>
</body>
</html> {% endcomment %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Visualization</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            background-image: url('/images/financials.jpg');
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
            color: white;
            font-family: Arial, sans-serif;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(5px);
        }
        
        h1 {
            margin-bottom: 20px;
            text-align: center;
            color: #4a90e2;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .upload-section {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        input[type="file"], 
        button {
            margin: 10px;
            padding: 12px 20px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background-color: rgba(74, 144, 226, 0.8);
            color: white;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background-color: rgba(74, 144, 226, 1);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        #analyticsSummary {
            margin: 30px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            color: #333;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .chart-wrapper {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            transition: transform 0.3s ease;
        }
        
        .chart-wrapper:hover {
            transform: translateY(-5px);
        }
        
        .chart-wrapper.full-width {
            grid-column: 1 / -1;
        }
        
        canvas {
            width: 100% !important;
            height: 350px !important;
        }
        
        /* Metric Cards Styling */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .metric-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.9);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
        }
        
        /* Loading state */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #4a90e2;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .chart-wrapper {
                min-width: 100%;
            }
            
            canvas {
                height: 300px !important;
            }
            
            .container {
                padding: 15px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üìä Analytics Dashboard</h1>
        
        <div class="upload-section">
            <input type="file" id="fileInput" accept=".csv" style="color: white;">
            <button id="uploadBtn">üìÅ Upload CSV File</button>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Processing data...</p>
            </div>
        </div>
        
        <div id="analyticsSummary" style="display: none;">
            <!-- Will be populated by JavaScript -->
        </div>
        
        <div class="charts-container" id="chartsContainer" style="display: none;">
            <div class="chart-wrapper">
                <h3 style="color: #333; margin-top: 0;">Quantity Sold</h3>
                <canvas id="quantityChart"></canvas>
            </div>
            <div class="chart-wrapper">
                <h3 style="color: #333; margin-top: 0;">Revenue Trend</h3>
                <canvas id="revenueChart"></canvas>
            </div>
            <div class="chart-wrapper full-width">
                <h3 style="color: #333; margin-top: 0;">Quantity vs Revenue Comparison</h3>
                <canvas id="combinedChart"></canvas>
            </div>
        </div>
    </div>
    
    <script>
        // Store chart instances for cleanup
        let chartInstances = {
            quantityChart: null,
            revenueChart: null,
            combinedChart: null
        };

        document.getElementById('uploadBtn').addEventListener('click', handleFileUpload);

        async function handleFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            const loadingElement = document.getElementById('loading');
            const summaryElement = document.getElementById('analyticsSummary');
            const chartsContainer = document.getElementById('chartsContainer');

            if (!file) {
                alert('Please select a CSV file first.');
                return;
            }

            // Reset previous displays
            summaryElement.style.display = 'none';
            chartsContainer.style.display = 'none';
            loadingElement.style.display = 'block';

            try {
                // Parse CSV directly in browser
                const csvText = await file.text();
                const salesData = parseCSVText(csvText);
                
                if (salesData.length === 0) {
                    throw new Error('No valid data found in CSV file.');
                }
                
                // Visualize the data
                visualizeData(salesData);
                
                // Show containers
                summaryElement.style.display = 'block';
                chartsContainer.style.display = 'grid';
                
            } catch (error) {
                alert('Error: ' + error.message);
                console.error('Error details:', error);
            } finally {
                loadingElement.style.display = 'none';
            }
        }

        // Improved CSV parsing with better error handling
        function parseCSVText(csvText) {
            try {
                const lines = csvText.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0);
                
                if (lines.length < 2) {
                    throw new Error('CSV file must contain header row and at least one data row');
                }
                
                // Extract headers (case-insensitive)
                const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                
                // Find column indices
                const dateIdx = headers.findIndex(h => h.includes('date'));
                const quantityIdx = headers.findIndex(h => h.includes('quantity') || h.includes('qty'));
                const revenueIdx = headers.findIndex(h => h.includes('revenue') || h.includes('amount'));
                
                if (dateIdx === -1) {
                    throw new Error('CSV must contain a "Date" column');
                }
                
                // Parse data rows
                const data = [];
                let errorCount = 0;
                
                for (let i = 1; i < lines.length; i++) {
                    try {
                        // Handle quoted fields and commas within quotes
                        const row = parseCSVRow(lines[i]);
                        
                        if (row.length < Math.max(dateIdx, quantityIdx, revenueIdx) + 1) {
                            console.warn(`Row ${i} has insufficient columns, skipping`);
                            errorCount++;
                            continue;
                        }
                        
                        const dateStr = row[dateIdx]?.trim();
                        const quantityStr = quantityIdx !== -1 ? row[quantityIdx]?.trim() : '0';
                        const revenueStr = revenueIdx !== -1 ? row[revenueIdx]?.trim() : '0';
                        
                        const processedRow = {
                            date: parseDate(dateStr),
                            quantity: parseNumber(quantityStr),
                            revenue: parseNumber(revenueStr),
                            rawDate: dateStr
                        };
                        
                        // Validate the date
                        if (isNaN(processedRow.date.getTime())) {
                            console.warn(`Invalid date in row ${i}: "${dateStr}", skipping`);
                            errorCount++;
                            continue;
                        }
                        
                        data.push(processedRow);
                        
                    } catch (rowError) {
                        console.warn(`Error parsing row ${i}:`, rowError);
                        errorCount++;
                    }
                }
                
                if (data.length === 0) {
                    throw new Error('No valid data rows could be parsed');
                }
                
                if (errorCount > 0) {
                    console.warn(`Skipped ${errorCount} invalid rows`);
                }
                
                // Sort by date
                return data.sort((a, b) => a.date - b.date);
                
            } catch (error) {
                throw new Error(`CSV parsing failed: ${error.message}`);
            }
        }

        // Helper function to parse CSV row with quotes
        function parseCSVRow(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current); // Add last field
            return result;
        }

        // Improved date parsing
        function parseDate(dateStr) {
            if (!dateStr || dateStr.trim() === '') {
                return new Date(); // Default to today
            }
            
            // Clean the date string
            dateStr = dateStr.trim().replace(/"/g, '');
            
            // Try common date formats
            const formats = [
                // DD/MM/YYYY or DD-MM-YYYY
                /^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/,
                // MM/DD/YYYY or MM-DD-YYYY
                /^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/,
                // YYYY/MM/DD or YYYY-MM-DD
                /^(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})$/,
                // DD/MM/YY or DD-MM-YY
                /^(\d{1,2})[\/-](\d{1,2})[\/-](\d{2})$/,
            ];
            
            for (const format of formats) {
                const match = dateStr.match(format);
                if (match) {
                    const parts = match.slice(1);
                    
                    // Determine format based on part lengths
                    if (parts[0].length === 4) {
                        // YYYY-MM-DD
                        return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                    } else if (parts[2].length === 4) {
                        // Try DD-MM-YYYY first, then MM-DD-YYYY
                        const date1 = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
                        const date2 = new Date(parseInt(parts[2]), parseInt(parts[0]) - 1, parseInt(parts[1]));
                        
                        // Return the valid date (check if month/day makes sense)
                        if (date1.getMonth() === parseInt(parts[1]) - 1) {
                            return date1;
                        } else {
                            return date2;
                        }
                    } else if (parts[2].length === 2) {
                        // DD-MM-YY
                        const year = parseInt(parts[2]) + 2000;
                        return new Date(year, parseInt(parts[1]) - 1, parseInt(parts[0]));
                    }
                }
            }
            
            // Fallback to Date.parse
            const parsed = Date.parse(dateStr);
            if (!isNaN(parsed)) {
                return new Date(parsed);
            }
            
            console.warn(`Could not parse date: "${dateStr}"`);
            return new Date(); // Default to today
        }

        // Helper to parse numbers
        function parseNumber(str) {
            if (!str) return 0;
            // Remove currency symbols, commas, etc.
            const cleaned = str.replace(/[$,]/g, '').trim();
            const num = parseFloat(cleaned);
            return isNaN(num) ? 0 : Math.abs(num);
        }

        // Visualize data
        function visualizeData(salesData) {
            console.log('Visualizing data:', salesData);
            
            // Clean up existing charts
            destroyCharts();
            
            // Create charts
            createQuantityChart(salesData);
            createRevenueChart(salesData);
            createCombinedChart(salesData);
            
            // Display analytics summary
            displayAnalyticsSummary(salesData);
        }

        // Clean up charts
        function destroyCharts() {
            Object.keys(chartInstances).forEach(chartId => {
                if (chartInstances[chartId]) {
                    chartInstances[chartId].destroy();
                    chartInstances[chartId] = null;
                }
            });
        }

        // Create quantity chart
        function createQuantityChart(data) {
            const dates = data.map(item => 
                item.date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                })
            );
            
            const quantities = data.map(item => item.quantity);
            const ctx = document.getElementById('quantityChart');
            
            if (!ctx) return;
            
            chartInstances.quantityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Quantity Sold',
                        data: quantities,
                        borderColor: 'rgba(54, 162, 235, 1)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        borderWidth: 3,
                        tension: 0.3,
                        pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                        pointRadius: 4,
                        pointHoverRadius: 8,
                        fill: true
                    }]
                },
                options: getChartOptions('Quantity Sold', 'Quantity', '#36a2eb')
            });
        }

        // Create revenue chart
        function createRevenueChart(data) {
            const dates = data.map(item => 
                item.date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                })
            );
            
            const revenues = data.map(item => item.revenue);
            const ctx = document.getElementById('revenueChart');
            
            if (!ctx) return;
            
            chartInstances.revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Revenue',
                        data: revenues,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        borderWidth: 3,
                        tension: 0.3,
                        pointBackgroundColor: 'rgba(75, 192, 192, 1)',
                        pointRadius: 4,
                        pointHoverRadius: 8,
                        fill: true
                    }]
                },
                options: getChartOptions('Revenue', 'Revenue ($)', '#4bc0c0')
            });
        }

        // Create combined chart
        function createCombinedChart(data) {
            const dates = data.map(item => 
                item.date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric'
                })
            );
            
            const quantities = data.map(item => item.quantity);
            const revenues = data.map(item => item.revenue);
            const ctx = document.getElementById('combinedChart');
            
            if (!ctx) return;
            
            chartInstances.combinedChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Quantity',
                            data: quantities,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            borderWidth: 2,
                            yAxisID: 'y',
                            tension: 0.2
                        },
                        {
                            label: 'Revenue ($)',
                            data: revenues,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            borderWidth: 2,
                            yAxisID: 'y1',
                            tension: 0.2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                        if (context.dataset.label.includes('Revenue')) {
                                            label += '$';
                                        }
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toLocaleString();
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Date', color: '#666' }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Quantity', color: '#36a2eb' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'Revenue ($)', color: '#ff6384' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        // Chart options helper
        function getChartOptions(title, yLabel, color) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true, position: 'top' },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toLocaleString();
                                    if (yLabel.includes('$')) {
                                        label = '$' + label;
                                    }
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: { display: true, text: 'Date', color: '#666' },
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    },
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: yLabel, color: color },
                        grid: { color: 'rgba(0,0,0,0.05)' },
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString();
                            }
                        }
                    }
                }
            };
        }

        // Display analytics summary
        function displayAnalyticsSummary(data) {
            const totalQuantity = data.reduce((sum, item) => sum + item.quantity, 0);
            const totalRevenue = data.reduce((sum, item) => sum + item.revenue, 0);
            const avgQuantity = totalQuantity / data.length;
            const avgRevenue = totalRevenue / data.length;
            const minQuantity = Math.min(...data.map(item => item.quantity));
            const maxQuantity = Math.max(...data.map(item => item.quantity));
            const minRevenue = Math.min(...data.map(item => item.revenue));
            const maxRevenue = Math.max(...data.map(item => item.revenue));
            
            // Calculate average price per unit
            const avgPricePerUnit = totalRevenue / totalQuantity || 0;
            
            const summaryDiv = document.getElementById('analyticsSummary');
            if (!summaryDiv) return;
            
            summaryDiv.innerHTML = `
                <h3 style="color: #2c3e50; margin-top: 0; text-align: center;">üìà Analytics Summary</h3>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label">Total Quantity</div>
                        <div class="metric-value">${totalQuantity.toLocaleString()}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Total Revenue</div>
                        <div class="metric-value">$${totalRevenue.toLocaleString()}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Avg Daily Quantity</div>
                        <div class="metric-value">${avgQuantity.toFixed(1)}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Avg Daily Revenue</div>
                        <div class="metric-value">$${avgRevenue.toFixed(0)}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Avg Price/Unit</div>
                        <div class="metric-value">$${avgPricePerUnit.toFixed(2)}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Data Points</div>
                        <div class="metric-value">${data.length}</div>
                    </div>
                </div>
                <div style="margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.05); border-radius: 8px;">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <div>
                            <strong>Quantity Range:</strong> ${minQuantity} - ${maxQuantity}
                        </div>
                        <div>
                            <strong>Revenue Range:</strong> $${minRevenue.toLocaleString()} - $${maxRevenue.toLocaleString()}
                        </div>
                    </div>
                </div>
            `;
        }

        // Add sample CSV download button
        document.addEventListener('DOMContentLoaded', function() {
            const uploadSection = document.querySelector('.upload-section');
            const sampleBtn = document.createElement('button');
            sampleBtn.id = 'sampleBtn';
            sampleBtn.textContent = 'üìã Download Sample CSV';
            sampleBtn.style.backgroundColor = 'rgba(155, 89, 182, 0.8)';
            uploadSection.appendChild(sampleBtn);
            
            sampleBtn.addEventListener('click', function() {
                const sampleCSV = `Date,Quantity,Revenue
31/1/2026,4,4200
01/02/26,3,3000
02/02/26,2,5500
03/02/26,5,6500
04/02/26,6,7200
05/02/26,4,4800
06/02/26,7,8400`;
                
                const blob = new Blob([sampleCSV], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'sample_sales_data.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            });
        });
    </script>
</body>
</html>